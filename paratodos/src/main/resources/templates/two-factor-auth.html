<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autentica칞칚o de Dois Fatores - Sistema RH Para Todos</title>
  <link rel="stylesheet" href="../static/styles/global.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      font-family: var(--font-family);
      background: white;
    }

    .branding-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 3rem;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .branding-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
      animation: pulse 15s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,
      100% {
        transform: scale(1);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.3;
      }
    }

    .branding-content {
      position: relative;
      z-index: 1;
      text-align: center;
      max-width: 500px;
    }

    .branding-icon {
      width: 100px;
      height: 100px;
      background: white;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      font-size: 3rem;
    }

    .branding-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .branding-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      line-height: 1.6;
    }

    .auth-container {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #5d6d7e 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 3rem;
    }

    .auth-header {
      margin-bottom: 2.5rem;
    }

    .auth-header h1 {
      font-size: 1.75rem;
      color: white;
      margin-bottom: 0.5rem;
    }

    .auth-header p {
      color: var(--gray-400);
      font-size: 0.95rem;
    }

    .auth-info {
      background: rgba(52, 152, 219, 0.1);
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 2rem;
      font-size: 0.9rem;
      color: var(--gray-300);
      line-height: 1.6;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--gray-400);
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      transition: all 0.2s ease;
      background: var(--gray-50);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-dark);
      background: white;
      box-shadow: 0 0 0 4px rgba(44, 62, 80, 0.1);
    }

    .form-input::placeholder {
      color: var(--gray-400);
    }

    .code-input-wrapper {
      display: flex;
      gap: 0.5rem;
      justify-content: space-between;
    }

    .code-input {
      width: 100%;
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: 600;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      text-align: center;
      background: var(--gray-50);
      transition: all 0.2s ease;
      letter-spacing: 0.5rem;
    }

    .code-input:focus {
      outline: none;
      border-color: var(--primary-dark);
      background: white;
      box-shadow: 0 0 0 4px rgba(44, 62, 80, 0.1);
    }

    .btn-verify {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
      background: var(--primary-dark);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-verify:hover {
      background: var(--primary-gray);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(44, 62, 80, 0.2);
    }

    .btn-verify:active {
      transform: translateY(0);
    }

    .btn-verify.loading {
      pointer-events: none;
      opacity: 0.8;
    }

    .btn-verify .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .form-footer {
      margin-top: 1.5rem;
      text-align: center;
    }

    .form-footer a {
      color: var(--gray-400);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .form-footer a:hover {
      text-decoration: underline;
    }

    .alert {
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert-error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--error-red);
      border: 1px solid rgba(231, 76, 60, 0.2);
    }

    .alert-success {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success-green);
      border: 1px solid rgba(39, 174, 96, 0.2);
    }

    .timer {
      text-align: center;
      color: var(--gray-400);
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }

    .timer strong {
      color: var(--primary-dark);
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn-secondary {
      flex: 1;
      padding: 0.875rem;
      font-size: 0.9rem;
      font-weight: 500;
      background: transparent;
      color: var(--gray-400);
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--gray-400);
      color: white;
    }

    @media (max-width: 1024px) {
      .branding-section {
        display: none;
      }

      .auth-container {
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .auth-container {
        padding: 2rem 1.5rem;
      }

      .auth-header h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="branding-section">
    <div class="branding-content">
      <div class="branding-icon">游댏</div>
      <h2 class="branding-title">Seguran칞a em Primeiro Lugar</h2>
      <p class="branding-subtitle">Sua conta est치 protegida com autentica칞칚o de dois fatores</p>
    </div>
  </div>

  <div class="auth-container">
    <div class="auth-header">
      <h1>Verifica칞칚o de Dois Fatores</h1>
      <p id="emailDisplay"></p>
    </div>

    <div class="alert alert-error" id="alertError"></div>
    <div class="alert alert-success" id="alertSuccess"></div>

    <div class="auth-info">
      游닎 Um c칩digo de verifica칞칚o foi enviado para seu email. Insira o c칩digo abaixo para prosseguir.
    </div>

    <form id="twoFactorForm" onsubmit="handleVerify2FA(event)">
      <div class="form-group">
        <label class="form-label" for="code">C칩digo de Verifica칞칚o</label>
        <input type="text" id="code" class="form-input" placeholder="Insira o c칩digo de 6 d칤gitos" maxlength="6" required
          autocomplete="off" inputmode="numeric">
      </div>

      <div class="timer" id="timer"></div>

      <button type="submit" class="btn-verify" id="btnVerify"><span>Verificar C칩digo</span></button>
    </form>

    <div class="actions">
      <button type="button" class="btn-secondary" onclick="handleResendCode()">Reenviar C칩digo</button>
      <button type="button" class="btn-secondary" onclick="handleCancel()">Cancelar</button>
    </div>

    <div class="form-footer">
      <p style="color: var(--gray-400); font-size: 0.85rem; margin-top: 1rem;">
        N칚o recebeu o c칩digo? Verifique sua pasta de spam ou solicite um novo envio.
      </p>
    </div>
  </div>

  <script src="../static/scripts/auth.js"></script>
  <script src="../static/scripts/two-factor-auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Redirecionar se n칚o h치 autentica칞칚o 2FA pendente
      if (!Auth.is2FAPending()) {
        window.location.href = 'index.html';
        return;
      }

      const pending = Auth.get2FAPending();
      document.getElementById('emailDisplay').textContent = `Autentique-se para ${pending.email}`;

      // Inicializar 2FA
      initializeTwoFactor();
    });

    function initializeTwoFactor() {
      const codeInput = document.getElementById('code');
      const pending = Auth.get2FAPending();

      // Foco autom치tico no campo de c칩digo
      codeInput.focus();

      // Permitir apenas n칰meros
      codeInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });

      // Enviar automaticamente quando tiver 6 d칤gitos
      codeInput.addEventListener('input', (e) => {
        if (e.target.value.length === 6) {
          document.getElementById('twoFactorForm').dispatchEvent(new Event('submit'));
        }
      });

      // Iniciar timer para resend
      startResendTimer();

      // Enviar c칩digo automaticamente ao carregar
      sendCodeIfNeeded();
    }

    async function sendCodeIfNeeded() {
      const pending = Auth.get2FAPending();
      if (!pending) return;

      try {
        await Auth.send2FACode(pending.email);
      } catch (error) {
        console.error('Erro ao enviar c칩digo:', error);
      }
    }

    async function handleVerify2FA(e) {
      e.preventDefault();

      const code = document.getElementById('code').value.trim();
      const pending = Auth.get2FAPending();

      if (!code || code.length !== 6) {
        showAlert('error', 'Por favor, insira um c칩digo v치lido de 6 d칤gitos.');
        return;
      }

      const btn = document.getElementById('btnVerify');
      btn.classList.add('loading');
      btn.innerHTML = '<div class="spinner"></div><span>Verificando...</span>';

      try {
        const result = await Auth.verify2FACode(pending.email, code, pending.tempToken);

        if (result.success) {
          showAlert('success', 'C칩digo verificado com sucesso! Redirecionando...');
          setTimeout(() => {
            const user = Auth.getCurrentUser();
            const nextPage = Auth.redirectAfterLogin(user);
            window.location.href = nextPage;
          }, 1000);
        } else {
          showAlert('error', result.message || 'C칩digo inv치lido. Tente novamente.');
          btn.classList.remove('loading');
          btn.innerHTML = '<span>Verificar C칩digo</span>';
          document.getElementById('code').value = '';
          document.getElementById('code').focus();
        }
      } catch (error) {
        showAlert('error', 'Erro ao verificar c칩digo. Tente novamente.');
        btn.classList.remove('loading');
        btn.innerHTML = '<span>Verificar C칩digo</span>';
      }
    }

    async function handleResendCode() {
      const pending = Auth.get2FAPending();
      if (!pending) return;

      const btn = event.target;
      btn.disabled = true;

      try {
        const result = await Auth.send2FACode(pending.email);
        showAlert('success', 'C칩digo reenviado com sucesso! Verifique seu email.');
        startResendTimer();
      } catch (error) {
        showAlert('error', 'Erro ao reenviar c칩digo. Tente novamente em alguns momentos.');
      } finally {
        btn.disabled = false;
      }
    }

    function handleCancel() {
      Auth.clear2FAPending();
      Auth.logout();
      window.location.href = 'index.html';
    }

    function showAlert(type, message) {
      const alertEl = document.getElementById(type === 'error' ? 'alertError' : 'alertSuccess');
      const otherAlert = document.getElementById(type === 'error' ? 'alertSuccess' : 'alertError');
      otherAlert.classList.remove('show');
      alertEl.textContent = message;
      alertEl.classList.add('show');
      if (type === 'success') setTimeout(() => alertEl.classList.remove('show'), 3000);
    }

    let resendCountdown = 0;

    function startResendTimer() {
      resendCountdown = 30;
      const resendBtn = document.querySelector('.btn-secondary');
      updateTimer();

      const interval = setInterval(() => {
        resendCountdown--;
        updateTimer();

        if (resendCountdown <= 0) {
          clearInterval(interval);
          resendBtn.disabled = false;
          resendBtn.textContent = 'Reenviar C칩digo';
        }
      }, 1000);
    }

    function updateTimer() {
      const timerEl = document.getElementById('timer');
      if (resendCountdown > 0) {
        timerEl.innerHTML = `Reenviar c칩digo em <strong>${resendCountdown}s</strong>`;
      } else {
        timerEl.innerHTML = '';
      }
    }
  </script>
</body>

</html>
