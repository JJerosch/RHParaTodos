<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Departamentos - Sistema RH</title>
  <link rel="stylesheet" href="../static/styles/global.css">
  <link rel="stylesheet" href="../static/styles/dashboard.css">
  <link rel="stylesheet" href="../static/styles/components.css">
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <img src="../static/assets/gruporhpaint.png" alt="logo_menu_lateral" height="60">
      </div>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <span class="nav-text">Dashboard</span>
      </a>

      <div class="nav-section">Gestão de Pessoas</div>
      <a href="employees.html" class="nav-item">
        <span class="nav-text">Funcionários</span>
      </a>
      <a href="departments.html" class="nav-item active">
        <span class="nav-text">Departamentos</span>
      </a>
      <a href="positions.html" class="nav-item">
        <span class="nav-text">Cargos</span>
      </a>

      <div class="nav-section">Recursos Humanos</div>
      <a href="recruitment.html" class="nav-item">
        <span class="nav-text">Recrutamento</span>
      </a>
      <a href="training.html" class="nav-item">
        <span class="nav-text">Treinamentos</span>
      </a>
      <a href="performance.html" class="nav-item">
        <span class="nav-text">Avaliações</span>
      </a>

      <div class="nav-section">Departamento Pessoal</div>
      <a href="payroll.html" class="nav-item">
        <span class="nav-text">Folha de Pagamento</span>
      </a>
      <a href="benefits.html" class="nav-item">
        <span class="nav-text">Benefícios</span>
      </a>
      <a href="vacation.html" class="nav-item">
        <span class="nav-text">Férias</span>
      </a>
      <a href="timesheet.html" class="nav-item">
        <span class="nav-text">Ponto</span>
      </a>

      <div class="nav-section">Administração</div>
      <a href="reports.html" class="nav-item">
        <span class="nav-text">Relatórios</span>
      </a>
      <a href="settings.html" class="nav-item">
        <span class="nav-text">Configurações</span>
      </a>
    </nav>
  </aside>


  <!-- Main Content -->
  <div class="main-content">
    <header class="topbar">
      <div class="topbar-left">
        <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>
        <h1>Departamentos</h1>
      </div>
      <div class="topbar-right">
        <div class="user-menu">
          <button class="user-button" id="userMenuButton">
            <span class="user-avatar" id="userAvatar">U</span>
            <span class="user-name" id="userName">Usuário</span>
            <span class="user-arrow">▼</span>
          </button>
          <div class="user-dropdown" id="userDropdown">
            <div class="user-info">
              <strong id="userFullName">Nome do Usuário</strong>
              <small id="userProfile">Perfil</small>
            </div>
            <hr>
            <a href="#" class="dropdown-item">Meu Perfil</a>
            <a href="settings.html" class="dropdown-item">Configurações</a>
            <hr>
            <a href="#" class="dropdown-item" id="logoutButton">Sair</a>
          </div>
        </div>
      </div>
    </header>

    <div class="content-area">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-box-header">
            <div class="stat-box-icon" style="background: rgba(44, 62, 80, 0.1); color: var(--primary-dark);"><img
                src="../static/assets/building-2.png" alt="icone_departamentos"></div>
          </div>
          <div class="stat-box-value" id="statTotal">0</div>
          <div class="stat-box-label">Total de Departamentos</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-header">
            <div class="stat-box-icon" style="background: rgba(39, 174, 96, 0.1); color: var(--success-green);"><img
                src="../static/assets/check (1).png" alt="icone_departamentos_ativos"></div>
          </div>
          <div class="stat-box-value" id="statAtivos">0</div>
          <div class="stat-box-label">Ativos</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-header">
            <div class="stat-box-icon" style="background: rgba(243, 156, 18, 0.1); color: var(--warning-orange);"><img
                src="../static/assets/users (1).png" alt="icone_total_funcionarios"></div>
          </div>
          <div class="stat-box-value" id="statFuncionarios">0</div>
          <div class="stat-box-label">Total de Funcionários</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-header">
            <div class="stat-box-icon" style="background: rgba(93, 109, 126, 0.1); color: var(--info-gray);"><img
                src="../static/assets/scale.png" alt="icone_media_departamento"></div>
          </div>
          <div class="stat-box-value" id="statMedia">0</div>
          <div class="stat-box-label">Média por Departamento</div>
        </div>
      </div>

      <!-- Page Header -->
      <div class="page-header">
        <div>
          <h2 class="page-title">Estrutura Organizacional</h2>
          <p class="page-subtitle">Gerencie os departamentos da empresa</p>
        </div>
        <div class="page-actions">
          <button class="btn btn-primary" onclick="openDepartmentModal()">+ Novo Departamento</button>
        </div>
      </div>

      <!-- Departments Grid -->
      <div class="departments-grid" id="departmentsGrid">
        <!-- Cards will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="departmentModal">
    <div class="modal-dialog modal-md">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Novo Departamento</h3>
        <button class="modal-close" onclick="Modal.close('departmentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="departmentForm">
          <input type="hidden" name="id">
          <div class="form-group">
            <label class="form-label">Nome do Departamento *</label>
            <input type="text" class="form-input" name="nome" required>
          </div>
          <div class="form-group">
            <label class="form-label">Descrição</label>
            <textarea class="form-input" name="descricao" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Departamento Pai</label>
            <select class="form-select" name="departamento_pai_id" id="parentDeptSelect">
              <option value="">Nenhum (Raiz)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="ativo" checked>
              <span>Departamento Ativo</span>
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="Modal.close('departmentModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveDepartment()">Salvar</button>
      </div>
    </div>
  </div>

  <style>
    .departments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-4);
    }

    .department-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--spacing-5);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      transition: all 0.2s;
    }

    .department-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .department-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-4);
    }

    .department-icon {
      width: 48px;
      height: 48px;
      background: var(--gray-100);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .department-actions {
      display: flex;
      gap: var(--spacing-1);
    }

    .department-name {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--spacing-1);
    }

    .department-desc {
      font-size: var(--font-size-sm);
      color: var(--gray-500);
      margin-bottom: var(--spacing-4);
    }

    .department-stats {
      display: flex;
      gap: var(--spacing-6);
      padding-top: var(--spacing-4);
      border-top: 1px solid var(--gray-100);
    }

    .department-stat {
      text-align: center;
    }

    .department-stat-value {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--primary-dark);
    }

    .department-stat-label {
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      text-transform: uppercase;
    }
  </style>

  <script src="../static/scripts/auth.js"></script>
  <script src="../static/scripts/components.js"></script>
  <script>
    // Mock data
    const departments = [
      { id: 1, nome: "Tecnologia", descricao: "Desenvolvimento de sistemas e infraestrutura", funcionarios: 45, cargos: 8, ativo: true },
      { id: 2, nome: "Recursos Humanos", descricao: "Gestão de pessoas e cultura organizacional", funcionarios: 12, cargos: 5, ativo: true },
      { id: 3, nome: "Financeiro", descricao: "Contabilidade, tesouraria e planejamento financeiro", funcionarios: 18, cargos: 6, ativo: true },
      { id: 4, nome: "Comercial", descricao: "Vendas, marketing e relacionamento com clientes", funcionarios: 35, cargos: 7, ativo: true },
      { id: 5, nome: "Operações", descricao: "Logística, produção e gestão operacional", funcionarios: 52, cargos: 9, ativo: true },
      { id: 6, nome: "Jurídico", descricao: "Assessoria jurídica e compliance", funcionarios: 8, cargos: 3, ativo: true }
    ];

    let currentDeptId = null;

    document.addEventListener("DOMContentLoaded", () => {
      if (!Auth.requireAuth()) return;
      initUserMenu();
      initSidebar();
      renderDepartments();
      updateStats();
    });

    function initUserMenu() {
      const user = Auth.getCurrentUser();
      if (user) {
        document.getElementById("userName").textContent = user.email?.split("@")[0] || user.username;
        document.getElementById("userAvatar").textContent = (user.email || user.username)[0].toUpperCase();
      }
      document.getElementById("userMenuButton").onclick = () => document.getElementById("userDropdown").classList.toggle("active");
      document.getElementById("logoutButton").onclick = (e) => { e.preventDefault(); Auth.logout(); };
      document.addEventListener("click", (e) => { if (!e.target.closest(".user-menu")) document.getElementById("userDropdown").classList.remove("active"); });
    }

    function initSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mobileBtn = document.getElementById('mobileMenuBtn');

      mobileBtn?.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
      });

      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          if (!e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
            sidebar.classList.remove('mobile-open');
          }
        }
      });
    }

    function updateStats() {
      const total = departments.length;
      const ativos = departments.filter(d => d.ativo).length;
      const funcionarios = departments.reduce((sum, d) => sum + d.funcionarios, 0);
      const media = Math.round(funcionarios / total);

      document.getElementById("statTotal").textContent = total;
      document.getElementById("statAtivos").textContent = ativos;
      document.getElementById("statFuncionarios").textContent = funcionarios;
      document.getElementById("statMedia").textContent = media;
    }

    function renderDepartments() {
      const grid = document.getElementById("departmentsGrid");

      grid.innerHTML = departments.map((dept, i) => `
        <div class="department-card">
          <div class="department-header">
            <div class="department-actions">
              <button class="btn-icon edit" onclick="editDepartment(${dept.id})" title="Editar"><img src="../static/assets/pencil (1).png" alt="icone_editar_departamento"></button>
              <button class="btn-icon delete" onclick="deleteDepartment(${dept.id})" title="Excluir"><img src="../static/assets/trash-2 (1).png" alt="icone_excluir_departamento"></button>
            </div>
          </div>
          <h3 class="department-name">${dept.nome}</h3>
          <p class="department-desc">${dept.descricao || 'Sem descrição'}</p>
          <div class="department-stats">
            <div class="department-stat">
              <div class="department-stat-value">${dept.funcionarios}</div>
              <div class="department-stat-label">Funcionários</div>
            </div>
            <div class="department-stat">
              <div class="department-stat-value">${dept.cargos}</div>
              <div class="department-stat-label">Cargos</div>
            </div>
            <div class="department-stat">
              <span class="badge ${dept.ativo ? 'badge-success' : 'badge-danger'}">${dept.ativo ? 'Ativo' : 'Inativo'}</span>
            </div>
          </div>
        </div>
      `).join('');

      // Update parent select
      const select = document.getElementById("parentDeptSelect");
      select.innerHTML = '<option value="">Nenhum (Raiz)</option>' +
        departments.map(d => `<option value="${d.id}">${d.nome}</option>`).join('');
    }

    function openDepartmentModal(id = null) {
      currentDeptId = id;
      document.getElementById("departmentForm").reset();

      if (id) {
        document.getElementById("modalTitle").textContent = "Editar Departamento";
        const dept = departments.find(d => d.id === id);
        if (dept) Form.populate('departmentForm', dept);
      } else {
        document.getElementById("modalTitle").textContent = "Novo Departamento";
      }

      Modal.open('departmentModal');
    }

    function editDepartment(id) { openDepartmentModal(id); }

    function saveDepartment() {
      const data = Form.serialize('departmentForm');

      if (!data.nome) {
        Toast.error('Nome é obrigatório');
        return;
      }

      if (currentDeptId) {
        const idx = departments.findIndex(d => d.id === currentDeptId);
        if (idx > -1) departments[idx] = { ...departments[idx], ...data, ativo: !!data.ativo };
        Toast.success('Departamento atualizado!');
      } else {
        departments.push({ id: Date.now(), ...data, ativo: !!data.ativo, funcionarios: 0, cargos: 0 });
        Toast.success('Departamento criado!');
      }

      Modal.close('departmentModal');
      renderDepartments();
      updateStats();
    }

    function deleteDepartment(id) {
      const dept = departments.find(d => d.id === id);
      Confirm.show(`Excluir o departamento <strong>${dept.nome}</strong>?`, () => {
        const idx = departments.findIndex(d => d.id === id);
        if (idx > -1) departments.splice(idx, 1);
        Toast.success('Departamento excluído!');
        renderDepartments();
        updateStats();
      });
    }
  </script>
</body>

</html>