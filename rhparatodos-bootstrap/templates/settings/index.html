<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head('Configurações')}"></head>
<body>
    <div class="app-wrapper">
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <main class="main-content">
            <div th:replace="~{fragments/header :: header(${breadcrumbs})}"></div>
            <div th:replace="~{fragments/header :: alerts}"></div>
            
            <div class="content-wrapper">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Configurações do Sistema</h1>
                        <p class="page-subtitle">Administre usuários, permissões e configurações gerais</p>
                    </div>
                </div>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabUsuarios">
                            <i class="bi bi-people me-1"></i> Usuários
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPerfis">
                            <i class="bi bi-shield-lock me-1"></i> Perfis de Acesso
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEmpresa">
                            <i class="bi bi-building me-1"></i> Dados da Empresa
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAuditoria">
                            <i class="bi bi-journal-text me-1"></i> Auditoria
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLGPD">
                            <i class="bi bi-shield-check me-1"></i> LGPD
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Tab Usuários -->
                    <div class="tab-pane fade show active" id="tabUsuarios">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-people me-2"></i>Usuários do Sistema</span>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalUsuario">
                                    <i class="bi bi-plus"></i> Novo Usuário
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Usuário</th>
                                                <th>Email</th>
                                                <th>Perfil</th>
                                                <th>Último Acesso</th>
                                                <th>Status</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="usuario : ${usuarios}">
                                                <td>
                                                    <div class="cell-with-avatar">
                                                        <div class="cell-avatar" th:text="${#strings.substring(usuario.nome, 0, 1)}">A</div>
                                                        <div class="cell-info">
                                                            <span class="cell-title" th:text="${usuario.nome}">Admin</span>
                                                            <span class="cell-subtitle" th:text="${usuario.funcionario?.matricula}">000001</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${usuario.email}">admin@empresa.com</td>
                                                <td>
                                                    <span class="badge bg-primary" th:text="${usuario.perfilDescricao}">Administrador</span>
                                                </td>
                                                <td th:text="${usuario.ultimoAcesso != null ? #temporals.format(usuario.ultimoAcesso, 'dd/MM/yyyy HH:mm') : 'Nunca'}">15/01/2026 10:30</td>
                                                <td>
                                                    <span class="badge badge-status" 
                                                          th:classappend="${usuario.ativo ? 'badge-ativo' : 'badge-desligado'}"
                                                          th:text="${usuario.ativo ? 'Ativo' : 'Inativo'}">Ativo</span>
                                                </td>
                                                <td>
                                                    <div class="table-actions">
                                                        <button class="btn-table-action edit" title="Editar" 
                                                                th:onclick="'editarUsuario(' + ${usuario.id} + ')'">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button class="btn-table-action" title="Resetar Senha"
                                                                th:onclick="'resetarSenha(' + ${usuario.id} + ')'">
                                                            <i class="bi bi-key"></i>
                                                        </button>
                                                        <button class="btn-table-action delete" title="Desativar"
                                                                th:if="${usuario.ativo}"
                                                                th:onclick="'desativarUsuario(' + ${usuario.id} + ')'">
                                                            <i class="bi bi-person-slash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Perfis -->
                    <div class="tab-pane fade" id="tabPerfis">
                        <div class="row">
                            <div th:each="perfil : ${perfis}" class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-shield-lock" th:style="'color: ' + ${perfil.cor}"></i>
                                            <span class="fw-semibold" th:text="${perfil.nome}">Administrador</span>
                                        </div>
                                        <span class="badge bg-secondary" th:text="${perfil.usuarios + ' usuários'}">5 usuários</span>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-3" th:text="${perfil.descricao}">
                                            Acesso total ao sistema
                                        </p>
                                        
                                        <h6 class="mb-2">Permissões:</h6>
                                        <div class="d-flex flex-wrap gap-1">
                                            <span th:each="perm : ${perfil.permissoes}" 
                                                  class="badge bg-light text-dark" th:text="${perm}">Permissão</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Descrição dos Perfis -->
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-info-circle me-2"></i>Descrição dos Perfis
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="accordionPerfis">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#perfilAdmin">
                                                <i class="bi bi-shield-fill-check me-2 text-danger"></i> Administrador do Sistema
                                            </button>
                                        </h2>
                                        <div id="perfilAdmin" class="accordion-collapse collapse show" data-bs-parent="#accordionPerfis">
                                            <div class="accordion-body">
                                                <p>Responsável pela administração geral do sistema, com acesso total às funcionalidades de RH e DP.</p>
                                                <strong>Pode:</strong>
                                                <ul class="small">
                                                    <li>Criar, editar e excluir usuários e perfis de acesso</li>
                                                    <li>Definir permissões e níveis de acesso</li>
                                                    <li>Acessar e gerenciar todos os módulos do sistema</li>
                                                    <li>Configurar autenticação, 2FA, políticas de senha e logs</li>
                                                    <li>Gerenciar consentimento e privacidade de dados (LGPD)</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#perfilRHChefe">
                                                <i class="bi bi-person-badge me-2 text-primary"></i> Chefe de RH
                                            </button>
                                        </h2>
                                        <div id="perfilRHChefe" class="accordion-collapse collapse" data-bs-parent="#accordionPerfis">
                                            <div class="accordion-body">
                                                <p>Responsável pela gestão estratégica de pessoas.</p>
                                                <strong>Pode:</strong>
                                                <ul class="small">
                                                    <li>Gerenciar cadastro, histórico e status dos funcionários</li>
                                                    <li>Criar e manter cargos, departamentos e hierarquias</li>
                                                    <li>Conduzir recrutamento e seleção (aprovação final)</li>
                                                    <li>Criar e gerir ciclos de avaliação de desempenho</li>
                                                    <li>Aprovar PDIs, promoções e políticas de remuneração</li>
                                                </ul>
                                                <strong>Não pode:</strong>
                                                <ul class="small text-muted">
                                                    <li>Gerenciar usuários do sistema</li>
                                                    <li>Executar ou fechar folha de pagamento</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#perfilDPChefe">
                                                <i class="bi bi-cash-stack me-2 text-success"></i> Chefe de DP
                                            </button>
                                        </h2>
                                        <div id="perfilDPChefe" class="accordion-collapse collapse" data-bs-parent="#accordionPerfis">
                                            <div class="accordion-body">
                                                <p>Responsável pela gestão e validação da folha de pagamento.</p>
                                                <strong>Pode:</strong>
                                                <ul class="small">
                                                    <li>Configurar e validar cálculos de folha</li>
                                                    <li>Gerar, revisar e fechar a folha de pagamento</li>
                                                    <li>Gerenciar férias, rescisões e 13º salário</li>
                                                    <li>Administrar benefícios com impacto financeiro</li>
                                                    <li>Gerar relatórios financeiros e contábeis</li>
                                                </ul>
                                                <strong>Não pode:</strong>
                                                <ul class="small text-muted">
                                                    <li>Alterar avaliações de desempenho</li>
                                                    <li>Acessar pesquisas de clima organizacional</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Empresa -->
                    <div class="tab-pane fade" id="tabEmpresa">
                        <form th:action="@{/configuracoes/empresa/salvar}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="bi bi-building me-2"></i>Dados da Empresa
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Razão Social</label>
                                            <input type="text" class="form-control" name="razaoSocial" 
                                                   th:value="${empresa?.razaoSocial}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nome Fantasia</label>
                                            <input type="text" class="form-control" name="nomeFantasia" 
                                                   th:value="${empresa?.nomeFantasia}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">CNPJ</label>
                                            <input type="text" class="form-control" name="cnpj" 
                                                   th:value="${empresa?.cnpj}" data-mask="cnpj">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Inscrição Estadual</label>
                                            <input type="text" class="form-control" name="inscricaoEstadual" 
                                                   th:value="${empresa?.inscricaoEstadual}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Inscrição Municipal</label>
                                            <input type="text" class="form-control" name="inscricaoMunicipal" 
                                                   th:value="${empresa?.inscricaoMunicipal}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="bi bi-gear me-2"></i>Configurações Gerais
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Fuso Horário</label>
                                            <select class="form-select" name="fusoHorario">
                                                <option value="America/Sao_Paulo" th:selected="${empresa?.fusoHorario == 'America/Sao_Paulo'}">São Paulo (GMT-3)</option>
                                                <option value="America/Manaus" th:selected="${empresa?.fusoHorario == 'America/Manaus'}">Manaus (GMT-4)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Formato de Data</label>
                                            <select class="form-select" name="formatoData">
                                                <option value="dd/MM/yyyy">DD/MM/AAAA</option>
                                                <option value="yyyy-MM-dd">AAAA-MM-DD</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Moeda</label>
                                            <select class="form-select" name="moeda">
                                                <option value="BRL">Real (R$)</option>
                                                <option value="USD">Dólar (US$)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i> Salvar Configurações
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tab Auditoria -->
                    <div class="tab-pane fade" id="tabAuditoria">
                        <div class="filters-card mb-4">
                            <div class="filters-row">
                                <div class="filter-group">
                                    <label class="form-label">Usuário</label>
                                    <select class="form-select">
                                        <option value="">Todos</option>
                                        <option th:each="u : ${usuarios}" th:value="${u.id}" th:text="${u.nome}">Usuário</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">Ação</label>
                                    <select class="form-select">
                                        <option value="">Todas</option>
                                        <option value="LOGIN">Login</option>
                                        <option value="LOGOUT">Logout</option>
                                        <option value="CREATE">Criação</option>
                                        <option value="UPDATE">Atualização</option>
                                        <option value="DELETE">Exclusão</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">Período</label>
                                    <input type="date" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-journal-text me-2"></i>Logs de Auditoria</span>
                                <a th:href="@{/configuracoes/auditoria/exportar}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download me-1"></i> Exportar
                                </a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Data/Hora</th>
                                                <th>Usuário</th>
                                                <th>Ação</th>
                                                <th>Recurso</th>
                                                <th>Detalhes</th>
                                                <th>IP</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="log : ${logs}">
                                                <td th:text="${#temporals.format(log.dataHora, 'dd/MM/yyyy HH:mm:ss')}">15/01/2026 10:30:45</td>
                                                <td th:text="${log.usuario}">admin</td>
                                                <td>
                                                    <span class="badge" th:classappend="${log.acao == 'LOGIN' ? 'bg-success' : (log.acao == 'DELETE' ? 'bg-danger' : 'bg-info')}"
                                                          th:text="${log.acao}">LOGIN</span>
                                                </td>
                                                <td th:text="${log.recurso}">Funcionário</td>
                                                <td class="small" th:text="${#strings.abbreviate(log.detalhes, 50)}">Atualizou cadastro de João Silva</td>
                                                <td class="small text-muted" th:text="${log.ip}">192.168.1.100</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab LGPD -->
                    <div class="tab-pane fade" id="tabLGPD">
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="bi bi-shield-check me-2"></i>Consentimento de Dados
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Configure os termos de consentimento para coleta de dados pessoais.</p>
                                        
                                        <div class="list-group">
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Dados Pessoais</strong>
                                                    <p class="mb-0 small text-muted">Nome, CPF, RG, Data Nascimento</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" checked disabled>
                                                </div>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Dados de Contato</strong>
                                                    <p class="mb-0 small text-muted">Email, Telefone, Endereço</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" checked disabled>
                                                </div>
                                            </div>
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>Dados Sensíveis</strong>
                                                    <p class="mb-0 small text-muted">Saúde, Biometria</p>
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" checked>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="bi bi-file-text me-2"></i>Solicitações de Titulares
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush">
                                            <div th:each="solicitacao : ${solicitacoesLGPD}" class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong th:text="${solicitacao.titular}">João Silva</strong>
                                                        <p class="mb-0 small text-muted" th:text="${solicitacao.tipo}">Exclusão de dados</p>
                                                    </div>
                                                    <span class="badge" th:classappend="${solicitacao.status == 'PENDENTE' ? 'bg-warning' : 'bg-success'}"
                                                          th:text="${solicitacao.status}">Pendente</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-clock-history me-2"></i>Retenção de Dados
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Configure o período de retenção de dados de acordo com as exigências legais.
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Dados de Funcionários Ativos</label>
                                        <select class="form-select">
                                            <option value="indefinido">Enquanto ativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Dados de Ex-Funcionários</label>
                                        <select class="form-select">
                                            <option value="5">5 anos após desligamento</option>
                                            <option value="10">10 anos após desligamento</option>
                                            <option value="20">20 anos após desligamento</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Novo Usuário -->
    <div class="modal fade" id="modalUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/configuracoes/usuarios/salvar}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="modal-header">
                        <h5 class="modal-title">Novo Usuário</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label required">Funcionário</label>
                            <select class="form-select" name="funcionarioId" required>
                                <option value="">Selecione um funcionário</option>
                                <option th:each="f : ${funcionariosSemUsuario}" th:value="${f.id}" 
                                        th:text="${f.nomeCompleto + ' - ' + f.matricula}">Funcionário</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Email de Acesso</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Perfil de Acesso</label>
                            <select class="form-select" name="perfil" required>
                                <option value="">Selecione</option>
                                <option value="ADMIN">Administrador</option>
                                <option value="RH_CHEFE">Chefe de RH</option>
                                <option value="RH_ASSISTENTE">Assistente de RH</option>
                                <option value="DP_CHEFE">Chefe de DP</option>
                                <option value="DP_ASSISTENTE">Assistente de DP</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="enviarEmail" id="enviarEmail" checked>
                            <label class="form-check-label" for="enviarEmail">Enviar email com credenciais de acesso</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Criar Usuário</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div th:replace="~{fragments/scripts :: scripts}"></div>
    
    <script>
        function resetarSenha(id) {
            Confirm.show({
                title: 'Resetar Senha',
                message: 'Uma nova senha será gerada e enviada por email. Deseja continuar?',
                confirmText: 'Resetar',
                confirmClass: 'btn-warning',
                onConfirm: () => {
                    window.location.href = `/configuracoes/usuarios/${id}/resetar-senha`;
                }
            });
        }
        
        function desativarUsuario(id) {
            Confirm.show({
                title: 'Desativar Usuário',
                message: 'O usuário não terá mais acesso ao sistema. Deseja continuar?',
                confirmText: 'Desativar',
                confirmClass: 'btn-danger',
                onConfirm: () => {
                    window.location.href = `/configuracoes/usuarios/${id}/desativar`;
                }
            });
        }
    </script>
</body>
</html>
