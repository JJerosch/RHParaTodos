<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head('Férias')}"></head>
<body>
    <div class="app-wrapper">
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <main class="main-content">
            <div th:replace="~{fragments/header :: header(${breadcrumbs})}"></div>
            <div th:replace="~{fragments/header :: alerts}"></div>
            
            <div class="content-wrapper">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="card stat-card card-border-left warning">
                        <div class="card-body">
                            <i class="bi bi-hourglass-split stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.pendentes ?: 0}">8</div>
                            <div class="stat-label">Pendentes de Aprovação</div>
                        </div>
                    </div>
                    <div class="card stat-card card-border-left success">
                        <div class="card-body">
                            <i class="bi bi-calendar-check stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.aprovadas ?: 0}">12</div>
                            <div class="stat-label">Aprovadas (mês)</div>
                        </div>
                    </div>
                    <div class="card stat-card card-border-left info">
                        <div class="card-body">
                            <i class="bi bi-person-walking stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.emGozo ?: 0}">5</div>
                            <div class="stat-label">Em Gozo Atualmente</div>
                        </div>
                    </div>
                    <div class="card stat-card card-border-left danger">
                        <div class="card-body">
                            <i class="bi bi-exclamation-triangle stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.vencidas ?: 0}">3</div>
                            <div class="stat-label">Férias Vencidas</div>
                        </div>
                    </div>
                </div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Gestão de Férias</h1>
                        <p class="page-subtitle">Controle de solicitações e períodos de férias</p>
                    </div>
                    <div class="page-actions">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSolicitacao">
                            <i class="bi bi-plus-lg me-1"></i> Nova Solicitação
                        </button>
                    </div>
                </div>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabPendentes">
                            <i class="bi bi-hourglass me-1"></i> Pendentes
                            <span class="badge bg-warning text-dark ms-1" th:text="${stats?.pendentes ?: 0}">8</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabAprovadas">
                            <i class="bi bi-check-circle me-1"></i> Aprovadas
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabVencidas">
                            <i class="bi bi-exclamation-circle me-1"></i> Vencidas/A Vencer
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCalendario">
                            <i class="bi bi-calendar3 me-1"></i> Calendário
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Tab Pendentes -->
                    <div class="tab-pane fade show active" id="tabPendentes">
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Funcionário</th>
                                                <th>Departamento</th>
                                                <th>Período</th>
                                                <th>Dias</th>
                                                <th>Abono</th>
                                                <th>Solicitado em</th>
                                                <th style="width: 180px;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="sol : ${solicitacoesPendentes}">
                                                <td>
                                                    <div class="cell-with-avatar">
                                                        <div class="cell-avatar" th:text="${#strings.substring(sol.funcionario.nomeCompleto, 0, 1)}">J</div>
                                                        <div class="cell-info">
                                                            <span class="cell-title" th:text="${sol.funcionario.nomeCompleto}">João Silva</span>
                                                            <span class="cell-subtitle" th:text="${sol.funcionario.matricula}">000001</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${sol.funcionario.departamento?.nome}">TI</td>
                                                <td>
                                                    <span th:text="${#temporals.format(sol.dataInicio, 'dd/MM')}">01/02</span>
                                                    a 
                                                    <span th:text="${#temporals.format(sol.dataFim, 'dd/MM/yy')}">28/02/26</span>
                                                </td>
                                                <td th:text="${sol.dias}">30</td>
                                                <td>
                                                    <span th:if="${sol.abonoPecuniario}" class="badge bg-info">Sim (10 dias)</span>
                                                    <span th:unless="${sol.abonoPecuniario}" class="text-muted">Não</span>
                                                </td>
                                                <td th:text="${#temporals.format(sol.dataSolicitacao, 'dd/MM/yyyy')}">10/01/2026</td>
                                                <td>
                                                    <form th:action="@{/ferias/{id}/aprovar(id=${sol.id})}" method="post" class="d-inline">
                                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                        <button type="submit" class="btn btn-sm btn-success" sec:authorize="hasAnyRole('ADMIN', 'RH_CHEFE', 'DP_CHEFE')">
                                                            <i class="bi bi-check-lg"></i> Aprovar
                                                        </button>
                                                    </form>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            th:onclick="'rejeitarFerias(' + ${sol.id} + ')'"
                                                            sec:authorize="hasAnyRole('ADMIN', 'RH_CHEFE', 'DP_CHEFE')">
                                                        <i class="bi bi-x-lg"></i> Rejeitar
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr th:if="${solicitacoesPendentes == null || solicitacoesPendentes.isEmpty()}">
                                                <td colspan="7">
                                                    <div class="empty-state py-4">
                                                        <i class="bi bi-check-circle empty-state-icon text-success"></i>
                                                        <h3 class="empty-state-title">Nenhuma solicitação pendente</h3>
                                                        <p class="empty-state-text">Todas as solicitações foram processadas.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Aprovadas -->
                    <div class="tab-pane fade" id="tabAprovadas">
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Funcionário</th>
                                                <th>Período</th>
                                                <th>Dias</th>
                                                <th>Status</th>
                                                <th>Aprovado por</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="sol : ${solicitacoesAprovadas}">
                                                <td>
                                                    <div class="cell-with-avatar">
                                                        <div class="cell-avatar" th:text="${#strings.substring(sol.funcionario.nomeCompleto, 0, 1)}">M</div>
                                                        <div class="cell-info">
                                                            <span class="cell-title" th:text="${sol.funcionario.nomeCompleto}">Maria Santos</span>
                                                            <span class="cell-subtitle" th:text="${sol.funcionario.departamento?.nome}">RH</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span th:text="${#temporals.format(sol.dataInicio, 'dd/MM')}">15/01</span>
                                                    a 
                                                    <span th:text="${#temporals.format(sol.dataFim, 'dd/MM/yy')}">14/02/26</span>
                                                </td>
                                                <td th:text="${sol.dias}">30</td>
                                                <td>
                                                    <span class="badge badge-status" 
                                                          th:classappend="${sol.emGozo ? 'badge-ferias' : 'badge-aprovado'}"
                                                          th:text="${sol.emGozo ? 'Em Gozo' : 'Agendadas'}">Agendadas</span>
                                                </td>
                                                <td th:text="${sol.aprovadoPor}">Carlos Lima</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" title="Ver Recibo">
                                                        <i class="bi bi-file-text"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Vencidas -->
                    <div class="tab-pane fade" id="tabVencidas">
                        <div class="alert alert-danger mb-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Atenção!</strong> Existem funcionários com férias vencidas ou próximas do vencimento.
                        </div>
                        
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Funcionário</th>
                                                <th>Período Aquisitivo</th>
                                                <th>Dias Disponíveis</th>
                                                <th>Vencimento</th>
                                                <th>Situação</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="fer : ${feriasVencidas}">
                                                <td>
                                                    <div class="cell-with-avatar">
                                                        <div class="cell-avatar" th:text="${#strings.substring(fer.funcionario.nomeCompleto, 0, 1)}">P</div>
                                                        <div class="cell-info">
                                                            <span class="cell-title" th:text="${fer.funcionario.nomeCompleto}">Pedro Almeida</span>
                                                            <span class="cell-subtitle" th:text="${fer.funcionario.departamento?.nome}">Comercial</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${fer.periodoAquisitivo}">2024/2025</td>
                                                <td th:text="${fer.diasDisponiveis}">30</td>
                                                <td th:text="${#temporals.format(fer.dataVencimento, 'dd/MM/yyyy')}">15/01/2026</td>
                                                <td>
                                                    <span class="badge" th:classappend="${fer.vencida ? 'bg-danger' : 'bg-warning text-dark'}"
                                                          th:text="${fer.vencida ? 'Vencida' : 'A Vencer'}">Vencida</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            th:onclick="'agendarFerias(' + ${fer.funcionario.id} + ')'">
                                                        <i class="bi bi-calendar-plus"></i> Agendar
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Calendário -->
                    <div class="tab-pane fade" id="tabCalendario">
                        <div class="card">
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Calendário visual de férias será implementado aqui usando FullCalendar.js
                                </div>
                                <div id="calendario" style="min-height: 500px;">
                                    <!-- Implementar com FullCalendar -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Solicitação -->
    <div class="modal fade" id="modalSolicitacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/ferias/solicitar}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="modal-header">
                        <h5 class="modal-title">Nova Solicitação de Férias</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label required">Funcionário</label>
                            <select class="form-select" name="funcionarioId" required>
                                <option value="">Selecione</option>
                                <option th:each="f : ${funcionarios}" th:value="${f.id}" th:text="${f.nomeCompleto}">Funcionário</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Data Início</label>
                                <input type="date" class="form-control" name="dataInicio" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Data Fim</label>
                                <input type="date" class="form-control" name="dataFim" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Dias de Férias</label>
                                <input type="number" class="form-control" name="dias" value="30" min="5" max="30">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Abono Pecuniário</label>
                                <select class="form-select" name="abonoPecuniario">
                                    <option value="false">Não</option>
                                    <option value="true">Sim (vender 10 dias)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" name="observacoes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Solicitar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Rejeição -->
    <div class="modal fade" id="modalRejeitar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formRejeitar" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="modal-header">
                        <h5 class="modal-title">Rejeitar Solicitação</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label required">Motivo da Rejeição</label>
                            <textarea class="form-control" name="motivoRejeicao" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Rejeitar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div th:replace="~{fragments/scripts :: scripts}"></div>
    
    <script>
        function rejeitarFerias(id) {
            document.getElementById('formRejeitar').action = `/ferias/${id}/rejeitar`;
            new bootstrap.Modal(document.getElementById('modalRejeitar')).show();
        }
        
        function agendarFerias(funcionarioId) {
            document.querySelector('[name="funcionarioId"]').value = funcionarioId;
            new bootstrap.Modal(document.getElementById('modalSolicitacao')).show();
        }
    </script>
</body>
</html>
