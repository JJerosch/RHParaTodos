<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head(${funcionario?.id != null ? 'Editar Funcionário' : 'Novo Funcionário'})}"></head>
<body>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div th:replace="~{fragments/header :: header(${breadcrumbs})}"></div>
            
            <!-- Alerts -->
            <div th:replace="~{fragments/header :: alerts}"></div>
            
            <!-- Content -->
            <div class="content-wrapper">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title" th:text="${funcionario?.id != null ? 'Editar Funcionário' : 'Novo Funcionário'}">Novo Funcionário</h1>
                        <p class="page-subtitle" th:text="${funcionario?.id != null ? 'Atualize as informações do funcionário' : 'Preencha os dados para cadastrar um novo funcionário'}">
                            Preencha os dados para cadastrar um novo funcionário
                        </p>
                    </div>
                    <div class="page-actions">
                        <a th:href="@{/funcionarios}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i> Voltar
                        </a>
                    </div>
                </div>
                
                <!-- Form -->
                <form th:action="${funcionario?.id != null ? '/funcionarios/' + funcionario.id + '/editar' : '/funcionarios/novo'}" 
                      method="post" id="funcionarioForm" class="needs-validation" novalidate>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" name="id" th:value="${funcionario?.id}"/>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <!-- Tabs Navigation -->
                            <ul class="nav nav-tabs" id="formTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="dados-tab" data-bs-toggle="tab" 
                                            data-bs-target="#dados" type="button" role="tab">
                                        <i class="bi bi-person me-1"></i> Dados Pessoais
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="contato-tab" data-bs-toggle="tab" 
                                            data-bs-target="#contato" type="button" role="tab">
                                        <i class="bi bi-telephone me-1"></i> Contato
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="profissional-tab" data-bs-toggle="tab" 
                                            data-bs-target="#profissional" type="button" role="tab">
                                        <i class="bi bi-briefcase me-1"></i> Dados Profissionais
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="bancario-tab" data-bs-toggle="tab" 
                                            data-bs-target="#bancario" type="button" role="tab">
                                        <i class="bi bi-bank me-1"></i> Dados Bancários
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="dependentes-tab" data-bs-toggle="tab" 
                                            data-bs-target="#dependentes" type="button" role="tab">
                                        <i class="bi bi-people me-1"></i> Dependentes
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tabs Content -->
                            <div class="tab-content" id="formTabsContent">
                                
                                <!-- Tab: Dados Pessoais -->
                                <div class="tab-pane fade show active" id="dados" role="tabpanel">
                                    <div class="form-section">
                                        <h4 class="form-section-title">Informações Básicas</h4>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="nomeCompleto" class="form-label required">Nome Completo</label>
                                                <input type="text" class="form-control" id="nomeCompleto" name="nomeCompleto" 
                                                       th:value="${funcionario?.nomeCompleto}" required maxlength="150">
                                                <div class="invalid-feedback">Nome completo é obrigatório.</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="cpf" class="form-label required">CPF</label>
                                                <input type="text" class="form-control" id="cpf" name="cpf" 
                                                       th:value="${funcionario?.cpf}" data-mask="cpf" required>
                                                <div class="invalid-feedback">CPF é obrigatório.</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="rg" class="form-label">RG</label>
                                                <input type="text" class="form-control" id="rg" name="rg" 
                                                       th:value="${funcionario?.rg}" data-mask="rg">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="dataNascimento" class="form-label required">Data de Nascimento</label>
                                                <input type="date" class="form-control" id="dataNascimento" name="dataNascimento" 
                                                       th:value="${funcionario?.dataNascimento}" required>
                                                <div class="invalid-feedback">Data de nascimento é obrigatória.</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="sexo" class="form-label">Sexo</label>
                                                <select class="form-select" id="sexo" name="sexo">
                                                    <option value="">Selecione</option>
                                                    <option value="M" th:selected="${funcionario?.sexo == 'M'}">Masculino</option>
                                                    <option value="F" th:selected="${funcionario?.sexo == 'F'}">Feminino</option>
                                                    <option value="O" th:selected="${funcionario?.sexo == 'O'}">Outro</option>
                                                    <option value="N" th:selected="${funcionario?.sexo == 'N'}">Prefiro não informar</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="estadoCivil" class="form-label">Estado Civil</label>
                                                <select class="form-select" id="estadoCivil" name="estadoCivil">
                                                    <option value="">Selecione</option>
                                                    <option value="SOLTEIRO" th:selected="${funcionario?.estadoCivil == 'SOLTEIRO'}">Solteiro(a)</option>
                                                    <option value="CASADO" th:selected="${funcionario?.estadoCivil == 'CASADO'}">Casado(a)</option>
                                                    <option value="DIVORCIADO" th:selected="${funcionario?.estadoCivil == 'DIVORCIADO'}">Divorciado(a)</option>
                                                    <option value="VIUVO" th:selected="${funcionario?.estadoCivil == 'VIUVO'}">Viúvo(a)</option>
                                                    <option value="UNIAO_ESTAVEL" th:selected="${funcionario?.estadoCivil == 'UNIAO_ESTAVEL'}">União Estável</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="nacionalidade" class="form-label">Nacionalidade</label>
                                                <input type="text" class="form-control" id="nacionalidade" name="nacionalidade" 
                                                       th:value="${funcionario?.nacionalidade ?: 'Brasileiro(a)'}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-section">
                                        <h4 class="form-section-title">Documentos</h4>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="pis" class="form-label">PIS/PASEP</label>
                                                <input type="text" class="form-control" id="pis" name="pis" 
                                                       th:value="${funcionario?.pis}" data-mask="pis">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="ctps" class="form-label">CTPS (Número/Série)</label>
                                                <input type="text" class="form-control" id="ctps" name="ctps" 
                                                       th:value="${funcionario?.ctps}" placeholder="000000/0000">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="tituloEleitor" class="form-label">Título de Eleitor</label>
                                                <input type="text" class="form-control" id="tituloEleitor" name="tituloEleitor" 
                                                       th:value="${funcionario?.tituloEleitor}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="cnh" class="form-label">CNH</label>
                                                <input type="text" class="form-control" id="cnh" name="cnh" 
                                                       th:value="${funcionario?.cnh}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="cnhCategoria" class="form-label">Categoria CNH</label>
                                                <select class="form-select" id="cnhCategoria" name="cnhCategoria">
                                                    <option value="">Selecione</option>
                                                    <option value="A" th:selected="${funcionario?.cnhCategoria == 'A'}">A</option>
                                                    <option value="B" th:selected="${funcionario?.cnhCategoria == 'B'}">B</option>
                                                    <option value="AB" th:selected="${funcionario?.cnhCategoria == 'AB'}">AB</option>
                                                    <option value="C" th:selected="${funcionario?.cnhCategoria == 'C'}">C</option>
                                                    <option value="D" th:selected="${funcionario?.cnhCategoria == 'D'}">D</option>
                                                    <option value="E" th:selected="${funcionario?.cnhCategoria == 'E'}">E</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="cnhValidade" class="form-label">Validade CNH</label>
                                                <input type="date" class="form-control" id="cnhValidade" name="cnhValidade" 
                                                       th:value="${funcionario?.cnhValidade}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab: Contato -->
                                <div class="tab-pane fade" id="contato" role="tabpanel">
                                    <div class="form-section">
                                        <h4 class="form-section-title">Telefones e Email</h4>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="telefoneCelular" class="form-label required">Celular</label>
                                                <input type="text" class="form-control" id="telefoneCelular" name="telefoneCelular" 
                                                       th:value="${funcionario?.telefoneCelular}" data-mask="phone" required>
                                                <div class="invalid-feedback">Celular é obrigatório.</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="telefoneFixo" class="form-label">Telefone Fixo</label>
                                                <input type="text" class="form-control" id="telefoneFixo" name="telefoneFixo" 
                                                       th:value="${funcionario?.telefoneFixo}" data-mask="phone">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="telefoneEmergencia" class="form-label">Contato de Emergência</label>
                                                <input type="text" class="form-control" id="telefoneEmergencia" name="telefoneEmergencia" 
                                                       th:value="${funcionario?.telefoneEmergencia}" data-mask="phone">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="emailPessoal" class="form-label required">Email Pessoal</label>
                                                <input type="email" class="form-control" id="emailPessoal" name="emailPessoal" 
                                                       th:value="${funcionario?.emailPessoal}" required>
                                                <div class="invalid-feedback">Email pessoal é obrigatório.</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="emailCorporativo" class="form-label">Email Corporativo</label>
                                                <input type="email" class="form-control" id="emailCorporativo" name="emailCorporativo" 
                                                       th:value="${funcionario?.emailCorporativo}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-section">
                                        <h4 class="form-section-title">Endereço</h4>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="cep" class="form-label">CEP</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="cep" name="cep" 
                                                           th:value="${funcionario?.cep}" data-mask="cep">
                                                    <button type="button" class="btn btn-outline-secondary" onclick="buscarCep()">
                                                        <i class="bi bi-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="logradouro" class="form-label">Logradouro</label>
                                                <input type="text" class="form-control" id="logradouro" name="logradouro" 
                                                       th:value="${funcionario?.logradouro}">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="numero" class="form-label">Número</label>
                                                <input type="text" class="form-control" id="numero" name="numero" 
                                                       th:value="${funcionario?.numero}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="complemento" class="form-label">Complemento</label>
                                                <input type="text" class="form-control" id="complemento" name="complemento" 
                                                       th:value="${funcionario?.complemento}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="bairro" class="form-label">Bairro</label>
                                                <input type="text" class="form-control" id="bairro" name="bairro" 
                                                       th:value="${funcionario?.bairro}">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="cidade" class="form-label">Cidade</label>
                                                <input type="text" class="form-control" id="cidade" name="cidade" 
                                                       th:value="${funcionario?.cidade}">
                                            </div>
                                            <div class="col-md-1 mb-3">
                                                <label for="uf" class="form-label">UF</label>
                                                <select class="form-select" id="uf" name="uf">
                                                    <option value="">--</option>
                                                    <option th:each="estado : ${estados}" th:value="${estado}" 
                                                            th:text="${estado}" th:selected="${funcionario?.uf == estado}">SP</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab: Dados Profissionais -->
                                <div class="tab-pane fade" id="profissional" role="tabpanel">
                                    <div class="form-section">
                                        <h4 class="form-section-title">Informações Profissionais</h4>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="matricula" class="form-label required">Matrícula</label>
                                                <input type="text" class="form-control" id="matricula" name="matricula" 
                                                       th:value="${funcionario?.matricula ?: proximaMatricula}" required readonly>
                                                <div class="form-text">Gerada automaticamente</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="dataAdmissao" class="form-label required">Data de Admissão</label>
                                                <input type="date" class="form-control" id="dataAdmissao" name="dataAdmissao" 
                                                       th:value="${funcionario?.dataAdmissao}" required>
                                                <div class="invalid-feedback">Data de admissão é obrigatória.</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="departamentoId" class="form-label required">Departamento</label>
                                                <select class="form-select" id="departamentoId" name="departamentoId" required>
                                                    <option value="">Selecione</option>
                                                    <option th:each="dept : ${departamentos}" th:value="${dept.id}" 
                                                            th:text="${dept.nome}" th:selected="${funcionario?.departamento?.id == dept.id}">Departamento</option>
                                                </select>
                                                <div class="invalid-feedback">Departamento é obrigatório.</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="cargoId" class="form-label required">Cargo</label>
                                                <select class="form-select" id="cargoId" name="cargoId" required>
                                                    <option value="">Selecione</option>
                                                    <option th:each="cargo : ${cargos}" th:value="${cargo.id}" 
                                                            th:text="${cargo.titulo}" th:selected="${funcionario?.cargo?.id == cargo.id}">Cargo</option>
                                                </select>
                                                <div class="invalid-feedback">Cargo é obrigatório.</div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="tipoContrato" class="form-label">Tipo de Contrato</label>
                                                <select class="form-select" id="tipoContrato" name="tipoContrato">
                                                    <option value="CLT" th:selected="${funcionario?.tipoContrato == 'CLT' || funcionario?.tipoContrato == null}">CLT</option>
                                                    <option value="PJ" th:selected="${funcionario?.tipoContrato == 'PJ'}">PJ</option>
                                                    <option value="ESTAGIO" th:selected="${funcionario?.tipoContrato == 'ESTAGIO'}">Estágio</option>
                                                    <option value="TEMPORARIO" th:selected="${funcionario?.tipoContrato == 'TEMPORARIO'}">Temporário</option>
                                                    <option value="APRENDIZ" th:selected="${funcionario?.tipoContrato == 'APRENDIZ'}">Jovem Aprendiz</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="salarioAtual" class="form-label required">Salário</label>
                                                <input type="text" class="form-control" id="salarioAtual" name="salarioAtual" 
                                                       th:value="${funcionario?.salarioAtual != null ? #numbers.formatDecimal(funcionario.salarioAtual, 1, 'POINT', 2, 'COMMA') : ''}" 
                                                       data-mask="currency" required>
                                                <div class="invalid-feedback">Salário é obrigatório.</div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="cargaHoraria" class="form-label">Carga Horária (h/semana)</label>
                                                <input type="number" class="form-control" id="cargaHoraria" name="cargaHoraria" 
                                                       th:value="${funcionario?.cargaHoraria ?: 44}" min="1" max="44">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="status" class="form-label">Status</label>
                                                <select class="form-select" id="status" name="status">
                                                    <option value="ATIVO" th:selected="${funcionario?.status == 'ATIVO' || funcionario?.status == null}">Ativo</option>
                                                    <option value="FERIAS" th:selected="${funcionario?.status == 'FERIAS'}">Em Férias</option>
                                                    <option value="AFASTADO" th:selected="${funcionario?.status == 'AFASTADO'}">Afastado</option>
                                                    <option value="DESLIGADO" th:selected="${funcionario?.status == 'DESLIGADO'}">Desligado</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="gestorId" class="form-label">Gestor Direto</label>
                                                <select class="form-select" id="gestorId" name="gestorId">
                                                    <option value="">Nenhum</option>
                                                    <option th:each="gestor : ${gestores}" th:value="${gestor.id}" 
                                                            th:text="${gestor.nomeCompleto}" 
                                                            th:selected="${funcionario?.gestor?.id == gestor.id}">Gestor</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab: Dados Bancários -->
                                <div class="tab-pane fade" id="bancario" role="tabpanel">
                                    <div class="form-section">
                                        <h4 class="form-section-title">Conta para Pagamento</h4>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="banco" class="form-label">Banco</label>
                                                <select class="form-select" id="banco" name="banco">
                                                    <option value="">Selecione</option>
                                                    <option value="001" th:selected="${funcionario?.banco == '001'}">001 - Banco do Brasil</option>
                                                    <option value="033" th:selected="${funcionario?.banco == '033'}">033 - Santander</option>
                                                    <option value="104" th:selected="${funcionario?.banco == '104'}">104 - Caixa Econômica</option>
                                                    <option value="237" th:selected="${funcionario?.banco == '237'}">237 - Bradesco</option>
                                                    <option value="341" th:selected="${funcionario?.banco == '341'}">341 - Itaú</option>
                                                    <option value="260" th:selected="${funcionario?.banco == '260'}">260 - Nubank</option>
                                                    <option value="077" th:selected="${funcionario?.banco == '077'}">077 - Inter</option>
                                                    <option value="756" th:selected="${funcionario?.banco == '756'}">756 - Sicoob</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="tipoConta" class="form-label">Tipo de Conta</label>
                                                <select class="form-select" id="tipoConta" name="tipoConta">
                                                    <option value="">Selecione</option>
                                                    <option value="CORRENTE" th:selected="${funcionario?.tipoConta == 'CORRENTE'}">Conta Corrente</option>
                                                    <option value="POUPANCA" th:selected="${funcionario?.tipoConta == 'POUPANCA'}">Poupança</option>
                                                    <option value="SALARIO" th:selected="${funcionario?.tipoConta == 'SALARIO'}">Conta Salário</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-3 mb-3">
                                                <label for="agencia" class="form-label">Agência</label>
                                                <input type="text" class="form-control" id="agencia" name="agencia" 
                                                       th:value="${funcionario?.agencia}" maxlength="10">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="conta" class="form-label">Conta</label>
                                                <input type="text" class="form-control" id="conta" name="conta" 
                                                       th:value="${funcionario?.conta}" maxlength="20">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="chavePix" class="form-label">Chave PIX</label>
                                                <input type="text" class="form-control" id="chavePix" name="chavePix" 
                                                       th:value="${funcionario?.chavePix}" placeholder="CPF, Email, Telefone ou Chave aleatória">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab: Dependentes -->
                                <div class="tab-pane fade" id="dependentes" role="tabpanel">
                                    <div class="form-section">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h4 class="form-section-title mb-0">Dependentes</h4>
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalDependente">
                                                <i class="bi bi-plus-lg me-1"></i> Adicionar Dependente
                                            </button>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="tabelaDependentes">
                                                <thead>
                                                    <tr>
                                                        <th>Nome</th>
                                                        <th>Parentesco</th>
                                                        <th>Data Nascimento</th>
                                                        <th>CPF</th>
                                                        <th>IR</th>
                                                        <th style="width: 80px;">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="listaDependentes">
                                                    <tr th:each="dep, stat : ${funcionario?.dependentes}">
                                                        <td th:text="${dep.nome}">Nome</td>
                                                        <td th:text="${dep.parentesco}">Filho(a)</td>
                                                        <td th:text="${#temporals.format(dep.dataNascimento, 'dd/MM/yyyy')}">01/01/2020</td>
                                                        <td th:text="${dep.cpf}">000.000.000-00</td>
                                                        <td>
                                                            <i class="bi" th:classappend="${dep.declaradoIr ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'}"></i>
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                    th:onclick="'removerDependente(' + ${stat.index} + ')'">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                            <input type="hidden" th:name="'dependentes[' + ${stat.index} + '].nome'" th:value="${dep.nome}">
                                                            <input type="hidden" th:name="'dependentes[' + ${stat.index} + '].parentesco'" th:value="${dep.parentesco}">
                                                            <input type="hidden" th:name="'dependentes[' + ${stat.index} + '].dataNascimento'" th:value="${dep.dataNascimento}">
                                                            <input type="hidden" th:name="'dependentes[' + ${stat.index} + '].cpf'" th:value="${dep.cpf}">
                                                            <input type="hidden" th:name="'dependentes[' + ${stat.index} + '].declaradoIr'" th:value="${dep.declaradoIr}">
                                                        </td>
                                                    </tr>
                                                    <tr th:if="${funcionario?.dependentes == null || funcionario.dependentes.isEmpty()}" id="semDependentes">
                                                        <td colspan="6" class="text-center text-muted py-4">
                                                            <i class="bi bi-people fs-3 d-block mb-2"></i>
                                                            Nenhum dependente cadastrado
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <a th:href="@{/funcionarios}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>
                            <span th:text="${funcionario?.id != null ? 'Atualizar' : 'Cadastrar'}">Cadastrar</span>
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <!-- Modal Dependente -->
    <div class="modal fade" id="modalDependente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Dependente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required">Nome Completo</label>
                        <input type="text" class="form-control" id="depNome" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Parentesco</label>
                            <select class="form-select" id="depParentesco" required>
                                <option value="">Selecione</option>
                                <option value="Cônjuge">Cônjuge</option>
                                <option value="Filho(a)">Filho(a)</option>
                                <option value="Enteado(a)">Enteado(a)</option>
                                <option value="Pai">Pai</option>
                                <option value="Mãe">Mãe</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Data de Nascimento</label>
                            <input type="date" class="form-control" id="depDataNascimento" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" id="depCpf" data-mask="cpf">
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="depDeclaradoIr">
                                <label class="form-check-label" for="depDeclaradoIr">Declarado no IR</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="adicionarDependente()">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <div th:replace="~{fragments/scripts :: scripts}"></div>
    
    <script>
        let dependentesCount = document.querySelectorAll('#listaDependentes tr:not(#semDependentes)').length;
        
        // Buscar CEP
        async function buscarCep() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length !== 8) {
                Toast.warning('CEP deve ter 8 dígitos');
                return;
            }
            
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                
                if (data.erro) {
                    Toast.error('CEP não encontrado');
                    return;
                }
                
                document.getElementById('logradouro').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade || '';
                document.getElementById('uf').value = data.uf || '';
                
                document.getElementById('numero').focus();
                Toast.success('Endereço preenchido!');
            } catch (error) {
                Toast.error('Erro ao buscar CEP');
            }
        }
        
        // Adicionar dependente
        function adicionarDependente() {
            const nome = document.getElementById('depNome').value;
            const parentesco = document.getElementById('depParentesco').value;
            const dataNascimento = document.getElementById('depDataNascimento').value;
            const cpf = document.getElementById('depCpf').value;
            const declaradoIr = document.getElementById('depDeclaradoIr').checked;
            
            if (!nome || !parentesco || !dataNascimento) {
                Toast.warning('Preencha os campos obrigatórios');
                return;
            }
            
            // Remover mensagem de "sem dependentes"
            document.getElementById('semDependentes')?.remove();
            
            const tbody = document.getElementById('listaDependentes');
            const index = dependentesCount++;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${nome}</td>
                <td>${parentesco}</td>
                <td>${new Date(dataNascimento + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td>${cpf || '-'}</td>
                <td><i class="bi ${declaradoIr ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'}"></i></td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDependente(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                    <input type="hidden" name="dependentes[${index}].nome" value="${nome}">
                    <input type="hidden" name="dependentes[${index}].parentesco" value="${parentesco}">
                    <input type="hidden" name="dependentes[${index}].dataNascimento" value="${dataNascimento}">
                    <input type="hidden" name="dependentes[${index}].cpf" value="${cpf}">
                    <input type="hidden" name="dependentes[${index}].declaradoIr" value="${declaradoIr}">
                </td>
            `;
            tbody.appendChild(tr);
            
            // Limpar modal
            document.getElementById('depNome').value = '';
            document.getElementById('depParentesco').value = '';
            document.getElementById('depDataNascimento').value = '';
            document.getElementById('depCpf').value = '';
            document.getElementById('depDeclaradoIr').checked = false;
            
            bootstrap.Modal.getInstance(document.getElementById('modalDependente')).hide();
            Toast.success('Dependente adicionado!');
        }
        
        // Remover dependente
        function removerDependente(btn) {
            const tr = btn.closest('tr');
            tr.remove();
            
            // Verificar se ainda há dependentes
            const tbody = document.getElementById('listaDependentes');
            if (tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr id="semDependentes">
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-people fs-3 d-block mb-2"></i>
                            Nenhum dependente cadastrado
                        </td>
                    </tr>
                `;
            }
        }
        
        // Validação do formulário
        document.getElementById('funcionarioForm').addEventListener('submit', function(e) {
            if (!this.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                
                // Encontrar primeiro campo inválido e ir para sua aba
                const invalidField = this.querySelector(':invalid');
                if (invalidField) {
                    const tabPane = invalidField.closest('.tab-pane');
                    if (tabPane) {
                        const tabId = tabPane.id + '-tab';
                        document.getElementById(tabId)?.click();
                    }
                }
            }
            this.classList.add('was-validated');
        });
        
        // Inicializar máscaras nos campos do modal
        document.getElementById('modalDependente').addEventListener('shown.bs.modal', function() {
            Mask.initAll();
        });
    </script>
</body>
</html>
