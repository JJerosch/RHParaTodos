<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head('Cargos e Salários')}"></head>
<body>
    <div class="app-wrapper">
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <main class="main-content">
            <div th:replace="~{fragments/header :: header(${breadcrumbs})}"></div>
            <div th:replace="~{fragments/header :: alerts}"></div>
            
            <div class="content-wrapper">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="card stat-card card-border-left">
                        <div class="card-body">
                            <i class="bi bi-briefcase stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.totalCargos ?: 0}">45</div>
                            <div class="stat-label">Total de Cargos</div>
                        </div>
                    </div>
                    <div class="card stat-card card-border-left success">
                        <div class="card-body">
                            <i class="bi bi-layers stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.totalNiveis ?: 0}">5</div>
                            <div class="stat-label">Níveis Hierárquicos</div>
                        </div>
                    </div>
                    <div class="card stat-card card-border-left info">
                        <div class="card-body">
                            <i class="bi bi-cash stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.mediaSalarial != null ? #numbers.formatCurrency(stats.mediaSalarial) : 'R$ 0'}">R$ 5.500</div>
                            <div class="stat-label">Média Salarial</div>
                        </div>
                    </div>
                    <div class="card stat-card card-border-left warning">
                        <div class="card-body">
                            <i class="bi bi-arrow-up-circle stat-icon"></i>
                            <div class="stat-value" th:text="${stats?.promocoesMes ?: 0}">8</div>
                            <div class="stat-label">Promoções (mês)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Cargos e Salários</h1>
                        <p class="page-subtitle">Gerencie a estrutura de cargos e política de remuneração</p>
                    </div>
                    <div class="page-actions" sec:authorize="hasAnyRole('ADMIN', 'RH_CHEFE')">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCargo">
                            <i class="bi bi-plus-lg me-1"></i> Novo Cargo
                        </button>
                    </div>
                </div>
                
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCargos">
                            <i class="bi bi-briefcase me-1"></i> Cargos
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFaixas">
                            <i class="bi bi-sliders me-1"></i> Faixas Salariais
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistorico">
                            <i class="bi bi-clock-history me-1"></i> Histórico de Reajustes
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Tab Cargos -->
                    <div class="tab-pane fade show active" id="tabCargos">
                        <div class="filters-card mb-4">
                            <div class="filters-row">
                                <div class="filter-group search">
                                    <label class="form-label">Buscar</label>
                                    <input type="text" class="form-control" placeholder="Nome do cargo..." id="buscaCargo">
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">Departamento</label>
                                    <select class="form-select" id="filtroDepartamento">
                                        <option value="">Todos</option>
                                        <option th:each="d : ${departamentos}" th:value="${d.id}" th:text="${d.nome}">Dept</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">Nível</label>
                                    <select class="form-select" id="filtroNivel">
                                        <option value="">Todos</option>
                                        <option value="ESTAGIARIO">Estagiário</option>
                                        <option value="JUNIOR">Junior</option>
                                        <option value="PLENO">Pleno</option>
                                        <option value="SENIOR">Senior</option>
                                        <option value="ESPECIALISTA">Especialista</option>
                                        <option value="COORDENADOR">Coordenador</option>
                                        <option value="GERENTE">Gerente</option>
                                        <option value="DIRETOR">Diretor</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="tabelaCargos">
                                        <thead>
                                            <tr>
                                                <th>Cargo</th>
                                                <th>Departamento</th>
                                                <th>Nível</th>
                                                <th class="text-end">Faixa Salarial</th>
                                                <th class="text-center">Ocupantes</th>
                                                <th>Status</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="cargo : ${cargos}">
                                                <td>
                                                    <div class="fw-semibold" th:text="${cargo.titulo}">Analista de Sistemas</div>
                                                    <small class="text-muted" th:text="${cargo.cbo}">CBO: 2124-05</small>
                                                </td>
                                                <td th:text="${cargo.departamento?.nome}">Tecnologia</td>
                                                <td>
                                                    <span class="badge bg-light text-dark" th:text="${cargo.nivelDescricao}">Senior</span>
                                                </td>
                                                <td class="text-end">
                                                    <span th:text="${#numbers.formatCurrency(cargo.salarioMinimo)}">R$ 8.000</span>
                                                    <span class="text-muted">-</span>
                                                    <span th:text="${#numbers.formatCurrency(cargo.salarioMaximo)}">R$ 12.000</span>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary" th:text="${cargo.ocupantes}">15</span>
                                                </td>
                                                <td>
                                                    <span class="badge badge-status" 
                                                          th:classappend="${cargo.ativo ? 'badge-ativo' : 'badge-desligado'}"
                                                          th:text="${cargo.ativo ? 'Ativo' : 'Inativo'}">Ativo</span>
                                                </td>
                                                <td>
                                                    <div class="table-actions">
                                                        <button class="btn-table-action view" title="Detalhes"
                                                                th:onclick="'verCargo(' + ${cargo.id} + ')'">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <button class="btn-table-action edit" title="Editar"
                                                                th:onclick="'editarCargo(' + ${cargo.id} + ')'"
                                                                sec:authorize="hasAnyRole('ADMIN', 'RH_CHEFE')">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Faixas Salariais -->
                    <div class="tab-pane fade" id="tabFaixas">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i>Tabela Salarial por Nível
                            </div>
                            <div class="card-body">
                                <canvas id="chartFaixas" height="300"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-table me-2"></i>Estrutura de Faixas</span>
                                <button class="btn btn-sm btn-outline-primary" sec:authorize="hasAnyRole('ADMIN', 'RH_CHEFE')">
                                    <i class="bi bi-pencil me-1"></i> Editar Tabela
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Nível</th>
                                                <th class="text-end">Mínimo</th>
                                                <th class="text-end">Médio</th>
                                                <th class="text-end">Máximo</th>
                                                <th class="text-center">Ocupantes</th>
                                                <th class="text-center">% do Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="faixa : ${faixasSalariais}">
                                                <td class="fw-semibold" th:text="${faixa.nivel}">Senior</td>
                                                <td class="text-end" th:text="${#numbers.formatCurrency(faixa.minimo)}">R$ 8.000</td>
                                                <td class="text-end" th:text="${#numbers.formatCurrency(faixa.medio)}">R$ 10.000</td>
                                                <td class="text-end" th:text="${#numbers.formatCurrency(faixa.maximo)}">R$ 12.000</td>
                                                <td class="text-center" th:text="${faixa.ocupantes}">45</td>
                                                <td class="text-center">
                                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                                        <div class="progress flex-grow-1" style="height: 6px; max-width: 80px;">
                                                            <div class="progress-bar" th:style="'width: ' + ${faixa.percentual} + '%'"></div>
                                                        </div>
                                                        <span class="small" th:text="${faixa.percentual + '%'}">28%</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Histórico -->
                    <div class="tab-pane fade" id="tabHistorico">
                        <div class="row">
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="bi bi-graph-up me-2"></i>Reajustes no Ano
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="fs-1 fw-bold text-primary" th:text="${totalReajustes ?: 0}">156</div>
                                        <p class="text-muted mb-3">Reajustes realizados</p>
                                        <hr>
                                        <div class="row text-center">
                                            <div class="col-6 border-end">
                                                <div class="fs-4 fw-semibold text-success" th:text="${promocoes ?: 0}">42</div>
                                                <small class="text-muted">Promoções</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="fs-4 fw-semibold text-info" th:text="${meritos ?: 0}">114</div>
                                                <small class="text-muted">Méritos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-8 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="bi bi-calendar3 me-2"></i>Evolução Mensal
                                    </div>
                                    <div class="card-body">
                                        <canvas id="chartReajustes" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-clock-history me-2"></i>Últimos Reajustes
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Funcionário</th>
                                                <th>Tipo</th>
                                                <th>Cargo Anterior</th>
                                                <th>Cargo Atual</th>
                                                <th class="text-end">Salário Anterior</th>
                                                <th class="text-end">Salário Atual</th>
                                                <th class="text-end">%</th>
                                                <th>Data</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="reajuste : ${ultimosReajustes}">
                                                <td>
                                                    <div class="cell-with-avatar">
                                                        <div class="cell-avatar" th:text="${#strings.substring(reajuste.funcionario.nomeCompleto, 0, 1)}">J</div>
                                                        <div class="cell-info">
                                                            <span class="cell-title" th:text="${reajuste.funcionario.nomeCompleto}">João Silva</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge" th:classappend="${reajuste.tipo == 'PROMOCAO' ? 'bg-success' : 'bg-info'}"
                                                          th:text="${reajuste.tipoDescricao}">Promoção</span>
                                                </td>
                                                <td th:text="${reajuste.cargoAnterior}">Analista Pleno</td>
                                                <td th:text="${reajuste.cargoAtual}">Analista Senior</td>
                                                <td class="text-end" th:text="${#numbers.formatCurrency(reajuste.salarioAnterior)}">R$ 7.000</td>
                                                <td class="text-end fw-semibold" th:text="${#numbers.formatCurrency(reajuste.salarioAtual)}">R$ 9.000</td>
                                                <td class="text-end text-success" th:text="${'+' + reajuste.percentual + '%'}">+28,5%</td>
                                                <td th:text="${#temporals.format(reajuste.data, 'dd/MM/yyyy')}">15/01/2026</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Cargo -->
    <div class="modal fade" id="modalCargo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/cargos/salvar}" method="post" id="formCargo">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" name="id" id="cargoId">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCargoTitle">Novo Cargo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label required">Título do Cargo</label>
                                <input type="text" class="form-control" name="titulo" id="cargoTitulo" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">CBO</label>
                                <input type="text" class="form-control" name="cbo" id="cargoCbo" placeholder="0000-00">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Departamento</label>
                                <select class="form-select" name="departamentoId" id="cargoDepartamento" required>
                                    <option value="">Selecione</option>
                                    <option th:each="d : ${departamentos}" th:value="${d.id}" th:text="${d.nome}">Dept</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Nível</label>
                                <select class="form-select" name="nivel" id="cargoNivel" required>
                                    <option value="">Selecione</option>
                                    <option value="ESTAGIARIO">Estagiário</option>
                                    <option value="JUNIOR">Junior</option>
                                    <option value="PLENO">Pleno</option>
                                    <option value="SENIOR">Senior</option>
                                    <option value="ESPECIALISTA">Especialista</option>
                                    <option value="COORDENADOR">Coordenador</option>
                                    <option value="GERENTE">Gerente</option>
                                    <option value="DIRETOR">Diretor</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Salário Mínimo</label>
                                <input type="text" class="form-control" name="salarioMinimo" id="cargoSalarioMin" 
                                       data-mask="currency" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Salário Médio</label>
                                <input type="text" class="form-control" name="salarioMedio" id="cargoSalarioMed" 
                                       data-mask="currency">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">Salário Máximo</label>
                                <input type="text" class="form-control" name="salarioMaximo" id="cargoSalarioMax" 
                                       data-mask="currency" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição do Cargo</label>
                            <textarea class="form-control" name="descricao" id="cargoDescricao" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Requisitos</label>
                            <textarea class="form-control" name="requisitos" id="cargoRequisitos" rows="2" 
                                      placeholder="Formação, experiência, habilidades..."></textarea>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="ativo" id="cargoAtivo" checked>
                            <label class="form-check-label" for="cargoAtivo">Cargo Ativo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div th:replace="~{fragments/scripts :: scripts}"></div>
    
    <script th:inline="javascript">
        const dadosFaixas = /*[[${dadosFaixas}]]*/ {
            labels: ['Estagiário', 'Junior', 'Pleno', 'Senior', 'Coordenador', 'Gerente'],
            minimos: [1500, 3000, 5000, 8000, 12000, 18000],
            maximos: [2000, 5000, 8000, 12000, 18000, 30000]
        };
        
        const dadosReajustes = /*[[${dadosReajustesMensal}]]*/ {
            labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
            promocoes: [5, 3, 8, 4, 6, 7],
            meritos: [12, 15, 10, 18, 14, 20]
        };
        
        // Gráfico Faixas
        new Chart(document.getElementById('chartFaixas'), {
            type: 'bar',
            data: {
                labels: dadosFaixas.labels,
                datasets: [{
                    label: 'Mínimo',
                    data: dadosFaixas.minimos,
                    backgroundColor: 'rgba(44, 62, 80, 0.6)'
                }, {
                    label: 'Máximo',
                    data: dadosFaixas.maximos,
                    backgroundColor: 'rgba(44, 62, 80, 0.9)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { ticks: { callback: (v) => 'R$ ' + (v/1000) + 'k' } }
                }
            }
        });
        
        // Gráfico Reajustes
        new Chart(document.getElementById('chartReajustes'), {
            type: 'bar',
            data: {
                labels: dadosReajustes.labels,
                datasets: [{
                    label: 'Promoções',
                    data: dadosReajustes.promocoes,
                    backgroundColor: '#27ae60'
                }, {
                    label: 'Méritos',
                    data: dadosReajustes.meritos,
                    backgroundColor: '#3498db'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { x: { stacked: true }, y: { stacked: true } }
            }
        });
        
        // Filtros
        document.getElementById('buscaCargo').addEventListener('keyup', filtrarCargos);
        document.getElementById('filtroDepartamento').addEventListener('change', filtrarCargos);
        document.getElementById('filtroNivel').addEventListener('change', filtrarCargos);
        
        function filtrarCargos() {
            const busca = document.getElementById('buscaCargo').value.toLowerCase();
            const dept = document.getElementById('filtroDepartamento').value;
            const nivel = document.getElementById('filtroNivel').value;
            
            document.querySelectorAll('#tabelaCargos tbody tr').forEach(row => {
                const titulo = row.querySelector('td:first-child .fw-semibold')?.textContent.toLowerCase() || '';
                const rowDept = row.querySelector('td:nth-child(2)')?.textContent || '';
                const rowNivel = row.querySelector('td:nth-child(3) .badge')?.textContent || '';
                
                const matchBusca = titulo.includes(busca);
                const matchDept = !dept || rowDept.includes(dept);
                const matchNivel = !nivel || rowNivel.toLowerCase().includes(nivel.toLowerCase());
                
                row.style.display = matchBusca && matchDept && matchNivel ? '' : 'none';
            });
        }
    </script>
</body>
</html>
